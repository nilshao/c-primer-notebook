# 第四章 网络层

## 概述

主要任务是把分组从远端传到目的段，为分组交换网上的不同主机提供通信服务。

网络层的传输单位是数据报。

+ 功能一：路由选择与分组转发：寻找最佳路径

+ 功能二：异构网络互联

+ 功能三：拥塞控制
：如果所有节点都来不及接受分组，而要丢弃大量分组的话，网络就处于拥塞状态，因此需要采取一定措施缓解这种拥塞。

    * 开环控制（静态）
    * 闭环控制（动态）

### 数据交换方式

如何使数据通过网络核心**路由器**从源主机到目的主机？————数据交换

### 为什么要数据交换？

### 数据交换方式

电路交换，报文交换，分组交换。分组交换又分数据报方式和虚电路方式

+ **电路交换**：例如电话网络

    * 建立连接（呼叫/电路建立） -> 通信 -> 释放连接（拆除电路）

    * 特点：独占资源

    * 优点：通信时延小，有序传输，没有冲突，实时性强

    * 缺点：建立连接时间长，线路独占，灵活性差，无差错控制能力

+ **报文交换**

    * 什么是报文：源应用发送的信息实体

    * 优点：不需要先建立连接；存储转发；动态分配线路；线路可靠性较高；线路利用率较高；多目标服务（指一个报文可以向多个目标传送）

    * 缺点：有存储转发时延；报文大小不定，需要网络节点有较大缓存空间。

+ **分组交换**

    * 把大的数据块分割成小的数据块。

    * 优点：无需建立连接；存储转发，动态分配线路；线路可靠性较高；线路利用率较高；相对于报文交换，存储管理更容易

    * 缺点：有存储转发时延；徐传输额外的信息量（每个报文都要有编号，头等）；乱序到达目的主机时，要对分组排序重组。

+ 报文交换和分组交换比较：

![报文交换分组交换比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/报文交换分组交换比较.JPG)


+ 三种数据交换方式比较总结

    ![三种数据报交换比较](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/三种数据报交换比较.JPG)


    1. 报文交换和分组交换都采用存储转发

    2. 传送数据量大，且传送时间远大于呼叫时，选择电路交换。电路交换传输时延最小。

    3. 从信道利用率来看，报文交换和分组交换优于电路交换，其中分组交换时延更小

+ 分组交换的**数据报方式**和**虚电路方式**

    * **数据报方式**为网络层提供无连接服务。无连接服务：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

    * **虚电路方式**为网络层提供连接服务。有连接服务：首先为分组的传输确定传输路径（建立连接），然后沿该路径（连接）传输系列分组，系列分组传输路径相同，传输结束后拆除连接。

### 几种传输单元名词辨析

|  层 | 传输单元 |
|  ---- | ----  |
|  应用层  | 报文  |
|  传输层 | 报文段  |
| 网络层  | IP数据报，分组 |
| 数据链路层  | 帧 |
| 物理层  | 比特流 |

### 数据报（因特网使用）

无连接。

每一个分组携带源和目的地址

路由器根据分组的目的地址转发分组：基于路由协议/算法 构建转发表；检索转发表，每个分组独立选路

转发表，最基础的两列：目的网络地址，链路接口

### 虚电路

虚电路方式将数据报方式和电路交换方式结合，以发挥两者优点。
虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接），
路径上所有的节点都要维持这条虚电路的建立，都维持一张虚电路表，
每一项记录了一个打开的虚电路的信息。

通信过程：

1. 建立连接（虚电路建立）：每个分组携带虚电路号，而非目的地址。源主机发送“呼叫请求“ 分组并收到“呼叫应答”分组后才算建立连接。

2. 数据传输：全双工通信

3. 释放连接（虚电路释放）：源主机发送“释放请求”分组 以拆除虚电路

### 数据报和虚电路比较

![数据报和虚电路](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/数据报和虚电路.JPG)

## IP数据报格式

### TCP/IP协议栈

TCP/IP协议栈的位置（橙色）

![TCP/IP协议栈](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/tcpip协议栈.JPG)

数据部分由运输层

![IP数据报格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/IP数据报格式.JPG)

固定部分为20字节固定长度

![IP数据报格式固定格式](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/IP数据报格式固定格式.JPG)

1. 版本：IPv4 or IPv6?

2. 首部长度：单位是4B，最小为5

3. 区分服务：指示期望获得那种类型的服务

4. 总长度：首部+数据长度，单位是1B

5. 生存时间（TTL）：IP分组的保质期，经过一个路由器-1，变成0则丢弃，防止未交付的数据报无线在链路上传输

6. 协议：数据部分的协议

![协议名字段值](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/协议名字段值.JPG)

7. 首部检验和：只检验首部，注意经过每个路由器都要更新一下，因为生存时间，片偏移会发生变化

8. 源地址和目的地址，32位，现在的IPv4的地址长度

9. 可选字段：0-40B，用来支持排错、测量以及安全等措施

10. 填充：全0，把首部补成4B的整数倍

## IP数据报分片

最大传送单元MTU：链路层**数据帧**可封装数据的上限。

以太网的MTU是1500字节

![最大传送单元MTU](https://github.com/nilshao/cpp-notebook/raw/master/internet/pictures/chapter04/最大传送单元MTU.JPG)

如果所传诵的数据报长度超过某链路的MTU值怎么办？————分片

11. 标识：统一数据报的不同分片使用同一标识

12. 标志：有三位但是只有两位有意义

    中间位DF（Dont Fragment)，DF=1禁止分片；DF=0允许分片

    最低位MF（More Fragment），MF=1，后面“还有分片”；MF=0，代表最后一片/）没有分片

13. 片偏移：指出较长分组分片后，某片在原分组中的相对位置，以8B为单位。

除了最后一个分片，每个分片长度一定是8B的整数倍。

### 例题

## IPv4地址

**IP地址：** 目的主机在哪个网络？哪个主机？
    全世界唯一的32位/4字节标识符，标识路由器主机的接口。IP地址::=网络号主机号（用另一个电脑修改一下，mac打不出来

### 分类的IP地址

（图片

以及特殊IP地址

（图片

因此有

以上这些都是”本网范围内“的私有IP地址

## 网络地址转换（NAT）

路由器对目的地址是私有IP地址的数据报一律不进行转发

网络地址转换NAT：在专用网连接到因特网的路由器上安装NAT软件，
安装了NAT软件的路由器叫NAT路由器，他至少有一个有效的外部全球IP地址。

（图片）

## 子网划分和子网掩码

分类的IP地址的弱点：

1. IP地址空间的利用率有时候很低

2. 两级IP地址不够灵活

图片（

两级IP地址->三级IP地址：某单位划分子网后，对外仍表现为一个网络，即本单位外的网络看不见本单位子网的划分。

子网掩码：

二级IP地址的子网掩码：只要是网络号都是1，主机号都是0；即255.255.0.0
（图片

三级，子网号部分也是全1。子网掩码与IP地址逐位相与，就得到子网网络地址。

子网掩码是用来确定有多少位是子网，多少位之后是主机号的。

## 使用子网时分组的转发

路由表中：

+ 目的网络地址

+ 目的网络子网掩码

+ 下一跳地址 

路由器转发分组的算法：

1. 提取目的IP地址

2. 是否直接交付

3. 特定主机路由

4. 检测路由表中有无路径

5. 默认路由0.0.0.0

6. 丢弃，报告转发分组错误

## 无分类编址CIDR

1. 消除了传统的A类，B类和C类地址以及划分子网的概念。
CIDR记法：IP地址后加上”/“，然后写上网络前缀，可以任意长度，的位置

（图片

2. 融合子网地址与子网掩码，方便子网划分。
CIDR把网络前缀相同的连续的IP地址组成一个”CIDR地址块“。
如：128.14.35.7/20是某CIDR地址块中的一个地址。
即：把128.14.35.7写成32位二进制，前二十位都是网络前缀。

（图片列成表格

### 构成超网

将多个子网聚合成一个较大的子网，叫做构成超网。或路由聚合。方法是将网络前缀缩短。



**最长前缀匹配**：使用CIDR时，查找路由表可能得到几个匹配结果，应选择**具有最长网络前缀**的路由。前缀越长，地址块越小，路由越具体。

（例题，写表格）
路由器R0的路由表见下表：若进入路由器R0的分组的目的地址是132.19.237.5,请问该分组应被转发到哪个下一跳路由器？ R2,(R3不匹配)

|  下一跳  |   目的网络  | 
|  ---- |  ---- | 
|   R1  |   132.0.0.0/8  | 
|   R2  |   132.0.0.0/11  | 
|   R3  |   132.19.232.0/22  | 
|   R4  |   0.0.0.0/8  | 

## ARP协议

由于在实际网络的链路上传送数据帧时，最终必须使用MAC地址。ARP协议：完成主机或路由器IP地址到MAC地址的映射。

ARP协议的使用过程：检查ARP高速缓存，有对应表项


## DHCP协议

## ICMP报文

ICMP协议支持主机或路由器：差错（或异常）报告，网络探询

### ICMP差错报告报文

1. 终点不可达：当路由器或主机不能交付数据报时就向原点发送终点不可达报文。

2. 源点一直：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，
使源点知道应当把数据报的发送速率放慢

3. 时间超过：当路由器收到生存时间TTL=0的数据报时，除了丢弃该数据报外，还要向源点发送时间超过报文。当重点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。

4. 参数问题：当路由器或目的主机收到的数据报首部中有的字段的值不正确时，就丢弃该数据报。并向原点发送参数问题报文。

5. 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。

（图片：ICMP差错报告报文数据字段

不应发送ICMP差错报文的情况

1. 对ICMP差错报告报文不再发送ICMP差错报告报文

2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报文

3. 对具有组播地址的数据报都不发送ICMP差错报告报文

4. 对具有特殊地址的数据报（本网络内的本主机地址0.0.0.0，环回地址127.0.0.0）都不发送ICMP差错报告报文

### ICMP询问报文

1. 回送请求和回答报文：主机或路由器向特定目的主机发送的询问（PING），收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。

2. 时间戳请求和回答报文：请某个主机或路由器回答当前的日期和时间，用来进行时钟同步和测量时间

3. 掩码地址请求和回答报文

4. 路由器询问和通告报文：3，4都不再使用

### ICMP的应用

PING：测试两个主机之间的连通性，使用了ICMP回送请求和回答报文

Traceroute：跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文。

把TTL依次设置为1，2，3...，就可以测算出终点到源点的距离


## IPv6

32位IPv4空间已经分配殆尽，采用CIDR和NAT，但是没有太大改善，
于是使用IPv6，从根本上解决了地址耗尽的问题。

IPv6改进了首部格式，加快路由器处理速度，转发数据报速度

支持QoS：Quality of Service，指一个网络能利用各种基础技术，
为指定的网络通信提供更好的服务能力，是一种安全机制，
用来解决网络延迟和阻塞的一种技术

### IPv6的数据报格式

固定40B首部：

+ 版本：指明了协议版本，总是6

+ 优先级：区分数据报的类别和优先级

+ 流标签：“流”是指互联网上从特定源点到特定终点的一系列数据报，所有属于同一个流的数据报都属于同一个流标签。

+ 有效载荷长度：指扩展首部/数据的长度

+ 下一个首部：表示下一个扩展首部或者上层协议首部

+ 

### 

























